#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
09_gerar_kml_mapa.py
====================
Gera arquivo KML para Google My Maps com indicadores consolidados por padaria.
CORREÃ‡ÃƒO: Cores fixas nas colunas da tabela (Pos=Verde, Neu=Amarelo, Neg=Vermelho).
"""

import pandas as pd
import json
import argparse
import sys
import html

# Tqdm Ã© opcional
try:
    from tqdm import tqdm
except ImportError:
    def tqdm(iterable, **kwargs):
        return iterable


# =============================================================================
# CONFIGURAÃ‡Ã•ES
# =============================================================================

SENTIMENTO_SCORE = {
    'positivo': 1.0, 
    'neutro': 0.0, 
    'negativo': -1.0
}

CATEGORIA_LABEL = {
    'comida': 'Comida', 
    'atendimento': 'Atend.', 
    'ambiente': 'Ambiente', 
    'preco': 'PreÃ§o', 
    'problemas': 'Probl.'
}

ORDEM_CATEGORIAS = ['comida', 'atendimento', 'ambiente', 'preco', 'problemas']


# =============================================================================
# FUNÃ‡Ã•ES DE CONSOLIDAÃ‡ÃƒO
# =============================================================================

def parsear_llm_json(json_str) -> list:
    if pd.isna(json_str):
        return []
    try:
        data = json.loads(json_str) if isinstance(json_str, str) else json_str
        return data.get('analises', [])
    except:
        return []


def consolidar_padaria(df_padaria: pd.DataFrame) -> dict:
    todas_analises = []
    for _, row in df_padaria.iterrows():
        for analise in parsear_llm_json(row.get('llm_analise_json')):
            todas_analises.append({
                'categoria': analise.get('categoria', '').lower(),
                'sentimento': analise.get('sentimento', '').lower(),
                'evidencia': analise.get('evidencia', '')
            })
    
    if not todas_analises:
        return None
    
    # 1. Sentimentos por categoria
    sentimentos_por_categoria = {}
    for cat in set(a['categoria'] for a in todas_analises if a['categoria']):
        cat_analises = [a for a in todas_analises if a['categoria'] == cat]
        total = len(cat_analises)
        if total > 0:
            sentimentos_por_categoria[cat] = {
                'positivo': round(sum(1 for a in cat_analises if a['sentimento'] == 'positivo') / total * 100, 1),
                'neutro': round(sum(1 for a in cat_analises if a['sentimento'] == 'neutro') / total * 100, 1),
                'negativo': round(sum(1 for a in cat_analises if a['sentimento'] == 'negativo') / total * 100, 1),
                'total': total
            }
    
    # 2. Top evidÃªncias
    positivas = [a for a in todas_analises if a['sentimento'] == 'positivo' and a['evidencia']][:3]
    negativas = [a for a in todas_analises if a['sentimento'] == 'negativo' and a['evidencia']][:3]
    top_evidencias = positivas + negativas
    
    # 3. Score mÃ©dio
    scores = [SENTIMENTO_SCORE.get(a['sentimento'], 0) for a in todas_analises]
    score_medio = sum(scores) / len(scores) if scores else 0
    
    # 4. Indicadores adicionais
    total_reviews = len(df_padaria)
    
    rating_google = None
    if 'rating' in df_padaria.columns:
        rating_google = df_padaria['rating'].mean()
        if pd.notna(rating_google):
            rating_google = round(rating_google, 2)
    
    respostas = 0
    if 'response_from_owner_text' in df_padaria.columns:
        respostas = df_padaria['response_from_owner_text'].notna().sum()
    taxa_resposta = round(respostas / total_reviews * 100, 1) if total_reviews > 0 else 0
    
    local_guides = 0
    if 'is_local_guide' in df_padaria.columns:
        local_guides = df_padaria['is_local_guide'].sum()
    pct_local_guides = round(local_guides / total_reviews * 100, 1) if total_reviews > 0 else 0
    
    price_range = None
    if 'price_range' in df_padaria.columns:
        pr = df_padaria['price_range'].iloc[0]
        if pd.notna(pr) and str(pr).strip() and str(pr) != 'nan':
            price_range = str(pr)
    
    return {
        'sentimentos_por_categoria': sentimentos_por_categoria,
        'top_evidencias': [(e['evidencia'], e['sentimento']) for e in top_evidencias],
        'score_medio': round(score_medio, 3),
        'total_reviews': total_reviews,
        'total_analises': len(todas_analises),
        'rating_google': rating_google,
        'taxa_resposta': taxa_resposta,
        'pct_local_guides': pct_local_guides,
        'price_range': price_range
    }


# =============================================================================
# GERAÃ‡ÃƒO DE FARÃ“IS E DESCRIÃ‡ÃƒO
# =============================================================================

def farol(valor: float) -> str:
    """
    Retorna emoji de farol baseado no SCORE GERAL apenas.
    """
    if valor >= 0.2:
        return 'ğŸŸ¢'
    elif valor >= -0.2:
        return 'ğŸŸ¡'
    else:
        return 'ğŸ”´'


def gerar_descricao(indicadores: dict, place_name: str, ranking: int = None, total_padarias: int = None) -> str:
    """
    Gera descriÃ§Ã£o formatada.
    """
    score = indicadores.get('score_medio', 0)
    
    # Status Texto
    if score >= 0.2:
        status = 'BOM'
    elif score >= -0.2:
        status = 'REGULAR'
    else:
        status = 'RUIM'
    
    desc = f'''â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¥– {place_name.upper()}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š RESUMO GERAL
{farol(score)} Score Sentimento: {score:+.2f} ({status})
'''
    
    if ranking and total_padarias:
        desc += f"ğŸ† Ranking: #{ranking} de {total_padarias}\n"
    if indicadores.get('rating_google'):
        desc += f"â­ Nota Google: {indicadores['rating_google']}\n"
    
    desc += f"ğŸ“ AvaliaÃ§Ãµes: {indicadores.get('total_reviews', 0):,}\n"
    desc += f"ğŸ’¬ MenÃ§Ãµes analisadas: {indicadores.get('total_analises', 0):,}\n"
    
    if indicadores.get('taxa_resposta', 0) > 0:
        desc += f"â†©ï¸ Taxa resposta dono: {indicadores['taxa_resposta']:.0f}%\n"
    if indicadores.get('pct_local_guides', 0) > 0:
        desc += f"ğŸ… Local Guides: {indicadores['pct_local_guides']:.0f}%\n"
    if indicadores.get('price_range'):
        desc += f"ğŸ’° Faixa de preÃ§o: {indicadores['price_range']}\n"

    # Tabela de sentimentos com CORES FIXAS para facilitar leitura
    desc += '''
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ SENTIMENTOS POR CATEGORIA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            POS    NEU    NEG
'''
    # DefiniÃ§Ã£o fixa das cores das colunas
    f_pos = 'ğŸŸ¢'
    f_neu = 'ğŸŸ¡' # Amarelo para neutro
    f_neg = 'ğŸ”´' # Vermelho para negativo
    
    for cat in ORDEM_CATEGORIAS:
        if cat in indicadores.get('sentimentos_por_categoria', {}):
            d = indicadores['sentimentos_por_categoria'][cat]
            label = CATEGORIA_LABEL.get(cat, cat.title())
            
            desc += f"{label:8} {f_pos}{d['positivo']:4.0f}%  {f_neu}{d['neutro']:4.0f}%  {f_neg}{d['negativo']:4.0f}%\n"

    # Top evidÃªncias
    desc += '''
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¬ O QUE DIZEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
'''
    for evidencia, sentimento in indicadores.get('top_evidencias', [])[:6]:
        emoji = 'âœ…' if sentimento == 'positivo' else ('âŒ' if sentimento == 'negativo' else 'â–')
        ev = (evidencia[:50] + '...') if len(evidencia) > 50 else evidencia
        desc += f"{emoji} {ev}\n"
    
    return desc


# =============================================================================
# GERAÃ‡ÃƒO DO KML
# =============================================================================

def gerar_kml(input_file: str, output_file: str) -> None:
    print(f"\nğŸ“‚ Carregando {input_file}...")
    try:
        df = pd.read_excel(input_file)
    except FileNotFoundError:
        print(f"âŒ Erro: Arquivo '{input_file}' nÃ£o encontrado.")
        sys.exit(1)
    
    if 'lat' not in df.columns or 'lng' not in df.columns:
        print("âŒ Dataset nÃ£o possui colunas 'lat' e 'lng'!")
        return
    
    total_padarias = df['place_id'].nunique()
    print(f"   {len(df):,} reviews | {total_padarias} padarias")
    
    print("\nğŸ“Š Calculando rankings...")
    rankings = {}
    scores_padarias = []
    
    for place_id in df['place_id'].unique():
        df_padaria = df[df['place_id'] == place_id]
        indicadores = consolidar_padaria(df_padaria)
        if indicadores:
            scores_padarias.append((place_id, indicadores['score_medio']))
    
    scores_padarias.sort(key=lambda x: x[1], reverse=True)
    for i, (place_id, _) in enumerate(scores_padarias, 1):
        rankings[place_id] = i
    
    # Ãcones oficiais do Google Maps (mais estÃ¡veis)
    kml_content = '''<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Padarias SP - Analise de Sentimentos</name>
<description>Mapa de sentimentos das padarias</description>

<Style id="verde">
  <IconStyle><scale>1.1</scale><Icon><href>http://googleusercontent.com/maps.google.com/mapfiles/ms/icons/green-dot.png</href></Icon></IconStyle>
</Style>
<Style id="amarelo">
  <IconStyle><scale>1.1</scale><Icon><href>http://googleusercontent.com/maps.google.com/mapfiles/ms/icons/yellow-dot.png</href></Icon></IconStyle>
</Style>
<Style id="vermelho">
  <IconStyle><scale>1.1</scale><Icon><href>http://googleusercontent.com/maps.google.com/mapfiles/ms/icons/red-dot.png</href></Icon></IconStyle>
</Style>
'''
    
    placemarks = []
    sem_coords = 0
    
    for place_id in tqdm(df['place_id'].unique(), desc="Gerando KML"):
        df_padaria = df[df['place_id'] == place_id]
        
        lat = df_padaria['lat'].iloc[0]
        lng = df_padaria['lng'].iloc[0]
        place_name = str(df_padaria['place_name'].iloc[0])
        
        if pd.isna(lat) or pd.isna(lng):
            sem_coords += 1
            continue
        
        indicadores = consolidar_padaria(df_padaria)
        if not indicadores:
            continue
        
        score = indicadores.get('score_medio', 0)
        ranking = rankings.get(place_id)
        
        if score >= 0.2: style_id = 'verde'
        elif score >= -0.2: style_id = 'amarelo'
        else: style_id = 'vermelho'
        
        place_name_safe = html.escape(place_name)
        descricao = gerar_descricao(indicadores, place_name, ranking, total_padarias)
        
        placemark = f'''
<Placemark>
  <name>{place_name_safe}</name>
  <description><![CDATA[{descricao}]]></description>
  <styleUrl>#{style_id}</styleUrl>
  <Point>
    <coordinates>{lng},{lat},0</coordinates>
  </Point>
</Placemark>'''
        placemarks.append(placemark)
    
    kml_content += '\n'.join(placemarks)
    kml_content += '\n</Document>\n</kml>'
    
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(kml_content)
    
    print(f"\nâœ… KML gerado: {output_file}")
    print(f"   ğŸŸ¢ Padarias no mapa: {len(placemarks)}")
    
    # EstatÃ­sticas
    verdes = sum(1 for p in placemarks if '#verde' in p)
    amarelos = sum(1 for p in placemarks if '#amarelo' in p)
    vermelhos = sum(1 for p in placemarks if '#vermelho' in p)
    print(f"\nğŸ“Š DistribuiÃ§Ã£o:")
    print(f"   ğŸŸ¢ Verde (score â‰¥ +0.2): {verdes}")
    print(f"   ğŸŸ¡ Amarelo (-0.2 a +0.2): {amarelos}")
    print(f"   ğŸ”´ Vermelho (score < -0.2): {vermelhos}")


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--input', '-i', required=True, help='Excel de entrada')
    parser.add_argument('--output', '-o', default='padarias_mapa.kml', help='KML de saÃ­da')
    args = parser.parse_args()
    
    gerar_kml(args.input, args.output)
